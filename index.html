<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–û—Ü—ñ–Ω–∫–∏ –Ω–∞ –ï–∫—Ä–∞–Ω</title>
<style>
  :root{
    --bg:#060708;
    --accent:#ffb86b;
    --muted:#9aa4ad;
    --score:#ff8a4b;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#fff;background:radial-gradient(800px 400px at 50% 40%, rgba(255,120,40,0.03), transparent 10%), var(--bg);overflow:hidden}
  .center{
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    flex-direction:column;
    text-align:center;
    padding:28px;
    box-sizing:border-box;
  }
  h1{margin:0;font-size:32px;color:var(--accent);text-shadow:0 6px 30px rgba(0,0,0,0.6)}
  .sub{color:var(--muted);margin-top:8px;font-size:14px}
  .name{font-weight:700;font-size:38px;margin-top:40px;opacity:0;transform:translateY(10px);transition:all .45s ease}
  .team{font-size:18px;color:#d1dbe6;margin-top:6px;opacity:0;transform:translateY(8px);transition:all .45s ease}
  .score{font-size:96px;line-height:1;margin-top:18px;color:var(--score);text-shadow:0 10px 40px rgba(255,138,75,0.12);opacity:0;transform:scale(.95);transition:all .6s cubic-bezier(.2,.8,.2,1)}
  .visible{opacity:1;transform:none}
  footer{position:absolute;bottom:8px;left:0;right:0;text-align:center;color:var(--muted);font-size:13px}
  /* leaves */
  .leaves{position:fixed;inset:0;pointer-events:none;z-index:2;overflow:hidden}
  .leaf{position:absolute;top:-20vh;font-size:28px;will-change:transform,opacity;opacity:0.95;filter:drop-shadow(0 8px 20px rgba(0,0,0,0.6))}
  /* small responsive */
  @media (max-width:600px){ .score{font-size:56px} .name{font-size:28px} }
</style>
</head>
<body>
  <div class="leaves" id="leaves"></div>

  <div class="center" role="main" aria-live="polite">
    <h1>–ó–æ–ª–æ—Ç–∞ –û—Å—ñ–Ω—å 2025 üçÅ</h1>
    <div class="sub">–î–∞–Ω—ñ –∑ Google Sheets ¬∑ –ê–≤—Ç–æ–æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–∂–Ω—ñ 5 —Å–µ–∫—É–Ω–¥</div>

    <div id="display">
      <div id="name" class="name">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
      <div id="team" class="team"></div>
      <div id="score" class="score">‚Äî</div>
    </div>
  </div>

  <footer id="status">–ü—ñ–¥–∫–ª—é—á–∞—é—Å—è...</footer>

<script>

const PUB_HTML = "https://docs.google.com/spreadsheets/d/1gBNHtvbDQ5welQn09qDcLFtVPMNwGL3OSI8zeC1pZN4/edit?gid=910619786#gid=910619786&single=true";
const GVIZ_JSON = "https://docs.google.com/spreadsheets/d/1gBNHtvbDQ5welQn09qDcLFtVPMNwGL3OSI8zeC1pZN4/edit?gid=910619786#gid=910619786&tqx=out:json";

const REFRESH = 5000; // –∫–æ–∂–Ω—ñ 5 —Å–µ–∫—É–Ω–¥
const ROW_TO_SHOW_INDEX 

const nameEl = document.getElementById("name");
const teamEl = document.getElementById("team");
const scoreEl = document.getElementById("score");
const statusEl = document.getElementById("status");

// –†–æ–±–∏–º–æ –¥–≤—ñ —Å–ø—Ä–æ–±–∏: 1) gviz JSON 2) pubhtml –ø–∞—Ä—Å–∏–Ω–≥
async function fetchGviz(){
  try {
    const r = await fetch(GVIZ_JSON, {cache: "no-store"});
    if (!r.ok) throw new Error("gviz fetch failed: " + r.status);
    const txt = await r.text();
    // gviz –ø–æ–≤–µ—Ä—Ç–∞—î JS-–≤–∏–∫–ª–∏–∫, —Ç—Ä–µ–±–∞ –≤–∏—á–∏—Å—Ç–∏—Ç–∏:
    const jsonText = txt.replace(/^[^{]*({[\s\S]*})\);?[\s\n]*$/,'$1');
    const obj = JSON.parse(jsonText);
    return obj;
  } catch (e){
    console.warn("gviz failed", e);
    throw e;
  }
}

async function fetchPubHtmlAndParse(){
  try {
    const r = await fetch(PUB_HTML, {cache: "no-store"});
    if (!r.ok) throw new Error("pubhtml fetch failed: " + r.status);
    const html = await r.text();
    // –ø–∞—Ä—Å–∏–º–æ HTML –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é DOMParser
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, "text/html");
    // –ø—É–±–ª—ñ—á–Ω–∏–π pubhtml –º—ñ—Å—Ç–∏—Ç—å —Ç–∞–±–ª–∏—Ü—é –∑ class="waffle" –∞–±–æ –ø—Ä–æ—Å—Ç–æ <table>
    // –∑–Ω–∞–π–¥–µ–º–æ –ø–µ—Ä—à—É —Ç–∞–±–ª–∏—Ü—é –∑ –¥–∞–Ω–∏–º–∏
    const table = doc.querySelector("table");
    if (!table) throw new Error("table not found in pubhtml");
    const trs = Array.from(table.querySelectorAll("tr"));
    // –Ø–∫—â–æ —Ç–∞–±–ª–∏—Ü—è –º–∞—î –∑–∞–≥–æ–ª–æ–≤–∫–∏, —Ç—Ä–µ–±–∞ –∑–Ω–∞–π—Ç–∏ 7-–π —Ñ—ñ–∑–∏—á–Ω–∏–π —Ä—è–¥–æ–∫
    const target = trs[ROW_TO_SHOW_INDEX];
    if (!target) throw new Error("row not found in pubhtml: index " + ROW_TO_SHOW_INDEX);
    const cells = Array.from(target.querySelectorAll("td,th")).map(td => td.textContent.trim());
    return {fromPubHtml:true, cells};
  } catch (e){
    console.warn("pubhtml failed", e);
    throw e;
  }
}

function showDataFromCells(cells){
  // –õ–æ–≥—ñ–∫—É –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –º–æ–∂–Ω–∞ –ø—ñ–¥–ª–∞—à—Ç—É–≤–∞—Ç–∏ –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏:
  // –ü—Ä–∏–ø—É—Å—Ç–∏–º–æ: [–Ü–º'—è, –ö–æ–º–∞–Ω–¥–∞, ..., –û—Ü—ñ–Ω–∫–∞] –∞–±–æ —ñ–Ω—à–∞ –¥–æ–≤–∂–∏–Ω–∞.
  // –í—ñ–∑—å–º–µ–º–æ –ø–µ—Ä—à—ñ 2 —è–∫ name/team, –æ—Å—Ç–∞–Ω–Ω—î —è–∫ score.
  const name = cells[0] || "‚Äî";
  const team = cells[1] || "";
  const score = cells.length > 2 ? cells[cells.length - 1] : (cells[1] || "‚Äî");

  // –ø–ª–∞–≤–Ω–∞ –∞–Ω—ñ–º–∞—Ü—ñ—è –ø–æ—è–≤–∏
  nameEl.textContent = name;
  teamEl.textContent = team;
  scoreEl.textContent = score;

  // –¥–æ–¥–∞—Ç–∏ –∫–ª–∞—Å visible –¥–ª—è –ø–ª–∞–≤–Ω–æ—ó –ø–æ—è–≤–∏
  setTimeout(()=> {
    nameEl.classList.add("visible");
    teamEl.classList.add("visible");
    scoreEl.classList.add("visible");
  }, 20);

  statusEl.textContent = "–û–Ω–æ–≤–ª–µ–Ω–æ: " + new Date().toLocaleTimeString();
}

function showError(msg){
  nameEl.textContent = "–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è";
  teamEl.textContent = "";
  scoreEl.textContent = "‚Äî";
  statusEl.textContent = msg;
  console.error(msg);
}

// –ì–æ–ª–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: —Å–ø–æ—á–∞—Ç–∫—É gviz -> —è–∫—â–æ –Ω—ñ, pubhtml
async function updateOnce(){
  // –ø—Ä–∏—Ö–æ–≤–∞—Ç–∏ –ø–æ–ø–µ—Ä–µ–¥–Ω—é –∞–Ω—ñ–º–∞—Ü—ñ—é
  nameEl.classList.remove("visible");
  teamEl.classList.remove("visible");
  scoreEl.classList.remove("visible");

  try {
    // 1) –ø—Ä–æ–±—É—î–º–æ gviz JSON
    const g = await fetchGviz();
    // –ø–∞—Ä—Å–∏–º–æ —Ç–∞–±–ª–∏—Ü—é
    const rows = (g.table && g.table.rows) ? g.table.rows : [];
    if (!rows || rows.length === 0) throw new Error("no rows in gviz");
    if (rows.length <= ROW_TO_SHOW_INDEX) throw new Error("gviz: not enough rows ("+rows.length+")");
    const rowObj = rows[ROW_TO_SHOW_INDEX];
    const cells = rowObj.c.map(c => (c && c.v !== undefined) ? String(c.v).trim() : "");
    showDataFromCells(cells);
    return;
  } catch (e1){
    // gviz –Ω–µ –≤–∏–π—à–ª–æ ‚Äî –ø—Ä–æ–±—É—î–º–æ pubhtml
    try {
      const pub = await fetchPubHtmlAndParse();
      if (pub && pub.cells) {
        showDataFromCells(pub.cells);
        return;
      } else {
        throw new Error("pubhtml parse returned nothing");
      }
    } catch (e2){
      showError("–ù–µ –≤–¥–∞—î—Ç—å—Å—è –ø—ñ–¥–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ. –ü–µ—Ä–µ–≤—ñ—Ä, —á–∏ —Ç–∞–±–ª–∏—Ü—è –ø—É–±–ª—ñ—á–Ω–∞.");
    }
  }
}

// –ø–µ—Ä—à–∏–π –≤–∏–∫–ª–∏–∫ + —ñ–Ω—Ç–µ—Ä–≤–∞–ª
updateOnce();
setInterval(updateOnce, REFRESH);

// ---------- –õ–∏—Å—Ç–æ—á–∫–∏ -----------
const leafChars = ["üçÅ","üçÇ","üçÉ"];
const leavesLayer = document.getElementById('leaves');

function spawnLeaf(){
  const el = document.createElement('div');
  el.className = 'leaf';
  const ch = leafChars[Math.floor(Math.random()*leafChars.length)];
  el.textContent = ch;
  const size = 18 + Math.random()*34;
  el.style.fontSize = size + 'px';
  el.style.left = (Math.random()*110 - 5) + 'vw';
  const dur = 6000 + Math.random()*9000;
  el.style.opacity = 0.9;
  leavesLayer.appendChild(el);

  // –∞–Ω—ñ–º–∞—Ü—ñ—è —á–µ—Ä–µ–∑ Web Animations API
  const sway = (Math.random()*120 - 60);
  el.animate([
    { transform: `translateY(-10vh) rotate(0deg)`, opacity: 1 },
    { transform: `translateY(110vh) translateX(${sway}px) rotate(${180+Math.random()*360}deg)`, opacity: 0.85 }
  ], { duration: dur, easing: 'ease-in', iterations: 1, fill: 'forwards' });

  setTimeout(()=> el.remove(), dur+50);
}

setInterval(()=>{
  const n = Math.random() < 0.7 ? 1 : (Math.random() < 0.3 ? 2 : 0);
  for (let i=0;i<n;i++) spawnLeaf();
}, 700);

// –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ: —è–∫—â–æ prefers-reduced-motion
if (window.matchMedia('(prefers-reduced-motion: reduce)').matches){
  document.getElementById('leaves').style.display = 'none';
}
</script>
</body>
</html>
